<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - PromptFill 管理后台</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    textarea { font-family: 'Consolas', 'Monaco', monospace; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- 顶部导航 -->
  <nav class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16">
        <div class="flex items-center gap-4">
          <a href="/admin" class="text-gray-600 hover:text-gray-800">← 返回</a>
          <h1 class="text-xl font-bold text-gray-800"><%= title %></h1>
        </div>
        <div class="flex items-center gap-4">
          <span class="text-gray-600">欢迎，<%= admin.username %></span>
          <a href="/admin/logout" class="text-red-600 hover:text-red-700">退出</a>
        </div>
      </div>
    </div>
  </nav>

  <div class="max-w-5xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <% if (error) { %>
      <div class="bg-red-50 border border-red-200 text-red-600 px-4 py-3 rounded-lg mb-6">
        <%= error %>
      </div>
    <% } %>

    <form
      method="POST"
      action="/admin/templates/<%= template ? template.id : '' %>"
      class="bg-white rounded-xl shadow-sm p-6 space-y-6"
    >
      <!-- 基本信息 -->
      <div class="grid grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            模板 ID <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            name="id"
            value="<%= template ? template.id : '' %>"
            <%= template ? 'readonly' : '' %>
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none <%= template ? 'bg-gray-100' : '' %>"
            placeholder="tpl_xxx"
          />
          <p class="text-xs text-gray-500 mt-1">建议使用 tpl_ 前缀，创建后不可修改</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">作者</label>
          <input
            type="text"
            name="author"
            value="<%= template ? template.author : '官方' %>"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
          />
        </div>
      </div>

      <!-- 名称 -->
      <div class="grid grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            中文名称 <span class="text-red-500">*</span>
          </label>
          <input
            type="text"
            name="name_cn"
            value="<%= template ? (template.name?.cn || template.name_cn || '') : '' %>"
            required
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
          />
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">英文名称</label>
          <input
            type="text"
            name="name_en"
            value="<%= template ? (template.name?.en || template.name_en || '') : '' %>"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
          />
        </div>
      </div>

      <!-- 中文内容 -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          中文内容 <span class="text-red-500">*</span>
        </label>
        <textarea
          name="content_cn"
          required
          rows="12"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"
          placeholder="支持 Markdown 和 {{变量名}} 语法"
        ><%= template ? (template.content?.cn || template.content_cn || '') : '' %></textarea>
        <p class="text-xs text-gray-500 mt-1">使用 {{变量名}} 定义可填空的变量</p>
      </div>

      <!-- 英文内容 -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">英文内容</label>
        <textarea
          name="content_en"
          rows="12"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"
          placeholder="English version (optional)"
        ><%= template ? (template.content?.en || template.content_en || '') : '' %></textarea>
      </div>

      <!-- 图片 -->
      <div class="grid grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">预览图 URL</label>
          <div class="flex gap-2">
            <input
              type="text"
              name="image_url"
              id="image_url"
              value="<%= template ? template.imageUrl : '' %>"
              class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
              placeholder="/uploads/xxx 或 https://..."
            />
            <label class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 cursor-pointer transition-colors">
              <span>上传</span>
              <input type="file" accept="image/*" class="hidden" onchange="uploadImage(this, 'image_url')" />
            </label>
          </div>
          <div id="image_url_preview" class="mt-2 hidden">
            <img src="" alt="预览" class="max-w-xs rounded-lg shadow-sm" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">多图 URL（每行一个）</label>
          <div class="flex gap-2">
            <textarea
              name="image_urls"
              id="image_urls"
              rows="3"
              class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm"
              placeholder="https://...&#10;https://..."
            ><%= template && template.imageUrls ? template.imageUrls.join('\n') : '' %></textarea>
            <label class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 cursor-pointer transition-colors h-fit">
              <span>上传</span>
              <input type="file" accept="image/*" multiple class="hidden" onchange="uploadMultipleImages(this)" />
            </label>
          </div>
        </div>
      </div>

      <!-- 标签和语言 -->
      <div class="grid grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">标签</label>
          <div class="flex flex-wrap gap-2">
            <% tags.forEach(function(tag) { %>
              <label class="inline-flex items-center">
                <input
                  type="checkbox"
                  name="tags"
                  value="<%= tag %>"
                  <%= template && template.tags && template.tags.includes(tag) ? 'checked' : '' %>
                  class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                />
                <span class="ml-1 text-sm text-gray-700"><%= tag %></span>
              </label>
            <% }) %>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">支持语言</label>
          <div class="flex gap-4">
            <label class="inline-flex items-center">
              <input
                type="checkbox"
                name="language"
                value="cn"
                <%= !template || (template.language && template.language.includes('cn')) ? 'checked' : '' %>
                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <span class="ml-1 text-sm text-gray-700">中文</span>
            </label>
            <label class="inline-flex items-center">
              <input
                type="checkbox"
                name="language"
                value="en"
                <%= !template || (template.language && template.language.includes('en')) ? 'checked' : '' %>
                class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
              />
              <span class="ml-1 text-sm text-gray-700">英文</span>
            </label>
          </div>
        </div>
      </div>

      <!-- 排序和状态 -->
      <div class="grid grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">排序顺序</label>
          <input
            type="number"
            name="sort_order"
            value="<%= template ? template.sortOrder : 0 %>"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
          />
          <p class="text-xs text-gray-500 mt-1">数字越小越靠前</p>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">状态</label>
          <label class="inline-flex items-center">
            <input
              type="checkbox"
              name="is_active"
              <%= !template || template.isActive ? 'checked' : '' %>
              class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
            />
            <span class="ml-2 text-sm text-gray-700">启用（前台可见）</span>
          </label>
        </div>
      </div>

      <!-- 默认选项 JSON（高级） -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          默认选项 (JSON)
          <span class="text-gray-400 font-normal">- 高级</span>
        </label>
        <textarea
          name="selections"
          rows="4"
          class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none text-sm font-mono"
          placeholder='{"variable_name": {"cn": "默认值", "en": "Default value"}}'
        ><%= template && template.selections ? JSON.stringify(template.selections, null, 2) : '{}' %></textarea>
        <p class="text-xs text-gray-500 mt-1">变量的默认选中值，JSON 格式</p>
      </div>

      <!-- 提交按钮 -->
      <div class="flex justify-end gap-4 pt-4 border-t">
        <a
          href="/admin"
          class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50"
        >
          取消
        </a>
        <button
          type="submit"
          class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
        >
          <%= template ? '保存修改' : '创建模板' %>
        </button>
      </div>
    </form>
  </div>

  <script>
    // 上传单张图片
    async function uploadImage(input, targetId) {
      const file = input.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('image', file);

      try {
        const response = await fetch('/api/upload/image', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          document.getElementById(targetId).value = data.url;

          // 显示预览
          const preview = document.getElementById(targetId + '_preview');
          if (preview) {
            preview.classList.remove('hidden');
            preview.querySelector('img').src = data.url;
          }
        } else {
          alert('上传失败: ' + (data.error || '未知错误'));
        }
      } catch (error) {
        alert('上传失败: ' + error.message);
      }

      input.value = '';
    }

    // 上传多张图片
    async function uploadMultipleImages(input) {
      const files = input.files;
      if (!files.length) return;

      const textarea = document.getElementById('image_urls');
      const existingUrls = textarea.value.trim();

      for (const file of files) {
        const formData = new FormData();
        formData.append('image', file);

        try {
          const response = await fetch('/api/upload/image', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            textarea.value = existingUrls
              ? textarea.value + '\n' + data.url
              : data.url;
          } else {
            alert('上传失败: ' + (data.error || '未知错误'));
          }
        } catch (error) {
          alert('上传失败: ' + error.message);
        }
      }

      input.value = '';
    }

    // 预览图显示
    document.addEventListener('DOMContentLoaded', function() {
      const imageUrl = document.getElementById('image_url').value;
      if (imageUrl) {
        const preview = document.getElementById('image_url_preview');
        preview.classList.remove('hidden');
        preview.querySelector('img').src = imageUrl;
      }
    });
  </script>
</body>
</html>
